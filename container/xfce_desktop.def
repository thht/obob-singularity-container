Bootstrap: docker
From: debian

%files
    files/00-aliases.sh /etc/profile.d/00-aliases.sh
    files/TurboVNC.list /etc/apt/sources.list.d/TurboVNC.list

%post
    export DEBIAN_FRONTEND=noninteractive

    # install turbovnc key
    wget -q -O- https://packagecloud.io/dcommander/turbovnc/gpgkey | gpg --dearmor >/etc/apt/trusted.gpg.d/TurboVNC.gpg

    apt update && apt -y full-upgrade
    # install xfce
    apt install -yq xfce4 dbus-x11 git wget procps xfce4-goodies firefox-esr build-essential python3-cairo python3-qtpy gnupg2 software-properties-common apt-transport-https curl vim sudo libopenblas64-openmp-dev git-lfs x11-apps zsh zsh-antigen ssh-askpass libtiff6 zsh tmux screen fonts-noto-cjk links links2 elinks lynx

    # install apptainer
    export APPTAINER_URL=$(wget -qO- 'https://api.github.com/repos/apptainer/apptainer/releases/latest' | grep '/apptainer_' | cut -d '"' -f4)
    wget -O /tmp/apptainer.deb $APPTAINER_URL
    apt install -yq /tmp/apptainer.deb

    # install gin
    curl -o gin.deb https://gin.g-node.org/G-Node/gin-cli-releases/raw/master/gin-cli-latest.deb
    apt install -yq ./gin.deb
    
    # install vscode
    curl -sSL https://packages.microsoft.com/keys/microsoft.asc | apt-key add -
    add-apt-repository --yes "deb [arch=amd64] https://packages.microsoft.com/repos/vscode stable main"
    add-apt-repository --yes "deb [arch=amd64] https://packages.microsoft.com/repos/vscode stable main"
    apt update
    apt install -yq code


    # install pycharm
    export PYCHARM_VERSION=$(wget -qO- 'https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=pycharm-professional' | grep pkgver= | cut -d "=" -f2)
    wget -O /tmp/pycharm.tar.gz https://download.jetbrains.com/python/pycharm-professional-$PYCHARM_VERSION.tar.gz
    tar xzf /tmp/pycharm.tar.gz -C /opt/
    mv /opt/pycharm-$PYCHARM_VERSION /opt/pycharm
    rm -rf /tmp/pycharm.tar.gz

    # install antibody
    curl -sfL git.io/antibody | sh -s - -b /usr/local/bin

    # make sure python works
    update-alternatives --install /usr/bin/python python /usr/bin/python3 1

    # install slurm
    apt install -yq libmunge-dev libmunge2 munge slurm-wlm slurm-wlm-doc

    # install turbovnc
    apt install -yq turbovnc


    # clean up
    apt-get clean
    rm -rf /var/lib/apt/lists/*

    # set permissions for /var/run
    chmod a+rwx /var/run /run/user /var/run/user

%apprun desktop
    dbus-launch xfce4-session

