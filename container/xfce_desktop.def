Bootstrap: docker
From: debian

%environment
    export THEANO_FLAGS='compile__timeout=1000,blas__ldflags="-lopenblas",base_compiledir="~/.theano"'

%files
    files/condor_config /etc/condor/condor_config
    files/00-aliases.sh /etc/profile.d/00-aliases.sh

%post
    export DEBIAN_FRONTEND=noninteractive
    apt update && apt -y full-upgrade
    # install xfce
    apt install -yq xfce4 dbus-x11 git wget procps xfce4-goodies firefox-esr build-essential python3-cairo python3-qtpy gnupg2 software-properties-common apt-transport-https curl vim sudo libatlas3-base libatlas-base-dev libblas3 libblas-dev libopenblas-base libopenblas-dev git-lfs x11-apps zsh zsh-antigen ssh-askpass singularity-container

    # install vscode
    curl -sSL https://packages.microsoft.com/keys/microsoft.asc | apt-key add -
    add-apt-repository "deb [arch=amd64] https://packages.microsoft.com/repos/vscode stable main"
    apt update
    apt install -yq code

    # install htcondor
    wget -qO - https://research.cs.wisc.edu/htcondor/repo/keys/HTCondor-9.0-Key | apt-key add -
    echo "deb [arch=amd64] http://research.cs.wisc.edu/htcondor/repo/debian/9.0 bullseye main" > /etc/apt/sources.list.d/htcondor.list
    apt update
    apt install -yq -o Dpkg::Options::="--force-confold" htcondor


    # install pycharm
    export PYCHARM_VERSION=$(wget -qO- 'https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=pycharm-professional' | grep pkgver= | cut -d "=" -f2)
    wget -O /tmp/pycharm.tar.gz https://download.jetbrains.com/python/pycharm-professional-$PYCHARM_VERSION.tar.gz
    tar xzf /tmp/pycharm.tar.gz -C /opt/
    mv /opt/pycharm-$PYCHARM_VERSION /opt/pycharm
    rm -rf /tmp/pycharm.tar.gz

    # install antibody
    curl -sfL git.io/antibody | sh -s - -b /usr/local/bin

    # make sure python works
    update-alternatives --install /usr/bin/python python /usr/bin/python3 1

    # clean up
    apt-get clean
    rm -rf /var/lib/apt/lists/*

    # set permissions for /var/run
    chmod a+rwx /var/run /run/user /var/run/user

%apprun desktop
    dbus-launch xfce4-session

